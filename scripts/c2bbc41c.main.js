"use strict";var EP=new Marionette.Application({Models:{},Collections:{},Views:{}});EP.addInitializer(function(){EP.addRegions({mainRegion:".js-main-region"})}),EP.addInitializer(function(a){Backbone.$.ajaxPrefilter(function(b,c){b.url=a.apiBaseUrl+b.url,b.data=$.param(_.extend(c.data||{},{client_id:a.clientId}))})}),EP.addInitializer(function(){EP.router=new EP.Router}),EP.addInitializer(function(){var a=new EP.Controller({router:EP.router,mainRegion:this.mainRegion});EP.router.processAppRoutes(a,{videos:"showVideos","videos/:id":"showVideo"}),EP.router.setHomePath("videos")}),EP.on("initialize:after",function(){Backbone.history&&Backbone.history.start()}),EP.Router=Marionette.AppRouter.extend({routes:{"":"navigateToHomePath"},navigateToHomePath:function(){this.navigate(this._homePath,{trigger:!0,replace:!0})},setHomePath:function(a){this._homePath=a}}),EP.Controller=Marionette.Controller.extend({initialize:function(a){this._router=a.router,this._mainRegion=a.mainRegion},showVideos:function(){var a=this._createVideosLayout();this._mainRegion.show(a),this._router.navigate("videos")},showVideo:function(a){var b=this._createVideoView(a);this._mainRegion.show(b),this._router.navigate("videos/"+a)},_createVideosLayout:function(){var a=new EP.Views.VideosLayout,b=this._createGamesFilterView(),c=this._createVideosListView();return a.on("show",function(){a.gamesFilterRegion.show(b),a.videosListRegion.show(c)}),a},_createVideosListView:function(){var a=this._getVideosCollection(),b=new EP.Views.VideosList({collection:a});return a.unsetFilterByGameId(),this.listenTo(b,"video:clicked",function(a){this.showVideo(a.model.id)}),b},_createGamesFilterView:function(){var a=new EP.Views.GamesFilter({collection:this._getGamesCollection()});return this.listenTo(a,"game:selected",this._filterVideosByGame),a},_createVideoView:function(a){var b=new EP.Views.Video({model:this._getVideoById(a)});return b},_getVideosCollection:function(){return this._videos=this._videos||this._createAndFetchVideosCollection(),this._videos},_createAndFetchVideosCollection:function(){var a=new EP.Collections.Videos;return a.fetch(),a},_getGamesCollection:function(){return this._games=this._games||this._createAndFetchGamesCollection(),this._games},_createAndFetchGamesCollection:function(){var a=new EP.Collections.Games;return a.fetch(),a},_filterVideosByGame:function(a){var b=this._getVideosCollection();b.setFilterByGameId(a)},_getVideoById:function(a){return this._getVideoFromVideosCollection(a)||this._createAndFetchVideoModel(a)},_getVideoFromVideosCollection:function(a){return this._videos?this._videos.get(a):void 0},_createAndFetchVideoModel:function(a){var b=new EP.Models.Video({id:a});return b.fetch(),b}}),EP.Models.Video=Backbone.Model.extend({urlRoot:"videos",defaults:{id:null,title:null,thumbnailUrl:null,posterUrl:null,mp4Url:null,hlsUrl:null,authorName:null,authorAvatarUrl:null,datePosted:null},parse:function(a){return{id:a.id,title:a.title,thumbnailUrl:a.thumbnail_url,posterUrl:a.base_url+a.thumbnail_files.high,mp4Url:a.base_url+a.video_files.high,hlsUrl:a.base_url+a.video_files.hls,authorName:a.user.username,authorAvatarUrl:a.user.avatar_url_small,datePosted:new Date(a.created_at)}}}),EP.Models.Game=Backbone.Model.extend({defaults:{id:null,name:null},parse:function(a){return _.pick(a,"id","name")}}),EP.Collections.Videos=Backbone.Collection.extend({url:function(){return this._gameId?"games/"+this._gameId+"/videos":"videos"},model:EP.Models.Video,fetchData:{order:"created_at"},fetch:function(a){return a=a||{},a.data=_.extend(a.data||{},this.fetchData),Backbone.Collection.prototype.fetch.call(this,a)},setFilterByGameId:function(a){this._gameId!==a&&(this._gameId=a,this.fetch({reset:!0}))},unsetFilterByGameId:function(){this._gameId&&(this._gameId=null,this.fetch({reset:!0}))}}),EP.Collections.Games=Backbone.Collection.extend({url:"games",model:EP.Models.Game}),EP.Views.VideosLayout=Marionette.Layout.extend({template:"#tpl-videos-layout",regions:{gamesFilterRegion:".js-games-filter-region",videosListRegion:".js-videos-list-region"}}),EP.Views.VideosListItem=Marionette.ItemView.extend({template:"#tpl-videos-list-item",triggers:{"click .js-video-thumbnail":"clicked"}}),EP.Views.VideosList=Marionette.CollectionView.extend({itemView:EP.Views.VideosListItem,itemViewEventPrefix:"video"}),EP.Views.GamesFilter=Marionette.ItemView.extend({template:"#tpl-games-filter",ui:{gamesFilterSelect:".js-games-filter-select"},events:{"change @ui.gamesFilterSelect":"onChangeGamesFilterSelect"},collectionEvents:{sync:"render"},onChangeGamesFilterSelect:function(){this.trigger("game:selected",this.ui.gamesFilterSelect.val())}}),EP.Views.Video=Marionette.ItemView.extend({template:"#tpl-video",modelEvents:{change:"render"}});